#include <Wire.h>
#include <LiquidCrystal_I2C.h>
#include <DHT.h>
#include <Servo.h>

#define DHTPIN 22       // Pin where the DHT11 is connected
#define DHTTYPE DHT11   // DHT sensor type

#define IN1  8
#define IN2  9
#define IN3  10
#define IN4  11
int Steps = 0;
boolean Direction = true;
unsigned long last_time;
unsigned long currentMillis;
int steps_left = 4095;
long time;

const int waterLevelPin = A0;
const int relayPin = 23;

const int soundSensorPin = A1;
const int redPin = 25;
const int greenPin = 26;
const int bluePin = 27;

const int trigPin = 13;
const int echoPin = 12;
const int servoPin = 28;
Servo myServo;

DHT dht(DHTPIN, DHTTYPE);
LiquidCrystal_I2C lcd(0x27, 16, 2);

unsigned long lastWaterLevelCheck = 0;
unsigned long lastUltrasonicCheck = 0;
unsigned long lastTemperatureHumidityCheck = 0;
unsigned long lastStepperMove = 0;
unsigned long lastDirectionChangeTime = 0;

void setup() {
  Serial.begin(115200);
  pinMode(IN1, OUTPUT); 
  pinMode(IN2, OUTPUT); 
  pinMode(IN3, OUTPUT); 
  pinMode(IN4, OUTPUT); 

  pinMode(waterLevelPin, INPUT);
  pinMode(relayPin, OUTPUT);

  pinMode(redPin, OUTPUT);
  pinMode(greenPin, OUTPUT);
  pinMode(bluePin, OUTPUT);

  pinMode(trigPin, OUTPUT);
  pinMode(echoPin, INPUT);
  myServo.attach(servoPin);

  lcd.init();
  lcd.backlight();
  dht.begin();
}

void loop() {
  handleWaterLevelControl();
  handleUltrasonicSensor();
  handleTemperatureHumidityMonitoring();
  handleStepperMotorControl();
  // Other tasks...
}
void handleWaterLevelControl() {
  unsigned long currentMillis = millis();

  // Check water level every 2 seconds
  if (currentMillis - lastWaterLevelCheck >= 2000) {
    lastWaterLevelCheck = currentMillis;

    int waterLevel = analogRead(waterLevelPin);
    int mappedLevel = map(waterLevel, 200, 430, 1, 10);

    if (mappedLevel < 5) {
      digitalWrite(relayPin, HIGH);
      Serial.println("Relay ON - Water level: " + String(mappedLevel));
    } else if (mappedLevel >= 10) {
      digitalWrite(relayPin, LOW);
      Serial.println("Relay OFF - Water level: " + String(mappedLevel));
    }
  }
}


void handleUltrasonicSensor() {
  unsigned long currentMillis = millis();

  if (currentMillis - lastUltrasonicCheck >= 100) {
    lastUltrasonicCheck = currentMillis;

    long duration, distance;

    digitalWrite(trigPin, LOW);
    delayMicroseconds(2);
    digitalWrite(trigPin, HIGH);
    delayMicroseconds(10);
    digitalWrite(trigPin, LOW);

    duration = pulseIn(echoPin, HIGH);
    distance = duration * 0.034 / 2;

    Serial.print("Distance: ");
    Serial.println(distance);

    if (distance <= 10) {
      myServo.write(90);
    } else {
      myServo.write(0);
    }
  }
}

void handleTemperatureHumidityMonitoring() {
  unsigned long currentMillis = millis();

  if (currentMillis - lastTemperatureHumidityCheck >= 2000) {
    lastTemperatureHumidityCheck = currentMillis;

    float humidity = dht.readHumidity();
    float temperature = dht.readTemperature();

    lcd.clear();
    lcd.setCursor(0, 0);
    lcd.print("Temp: ");
    lcd.print(temperature);
    lcd.print("C");

    lcd.setCursor(0, 1);
    lcd.print("Humidity: ");
    lcd.print(humidity);
    lcd.print("%");
  }
}

void handleStepperMotorControl() {
  unsigned long currentMillis = micros();

  if (steps_left > 0) {
    if (currentMillis - last_time >= 1000) {
      stepper(1);
      time = time + micros() - last_time;
      last_time = micros();
      steps_left--;
    }
  } else {
    Serial.println(time);
    if (millis() - lastDirectionChangeTime >= 10000) {
      Serial.println("Waited 10 seconds, changing direction...");
      Direction = !Direction;
      steps_left = 4095;
      lastDirectionChangeTime = millis();
    } else {
      Serial.println("Waiting 10 seconds before changing direction...");
    }
  }
}


void stepper(int xw) {
  for (int x = 0; x < xw; x++) {
    switch (Steps) {
      case 0:
        digitalWrite(IN1, LOW); 
        digitalWrite(IN2, LOW);
        digitalWrite(IN3, LOW);
        digitalWrite(IN4, HIGH);
        break; 
      case 1:
        digitalWrite(IN1, LOW); 
        digitalWrite(IN2, LOW);
        digitalWrite(IN3, HIGH);
        digitalWrite(IN4, HIGH);
        break;
      case 2:
        digitalWrite(IN1, LOW); 
        digitalWrite(IN2, LOW);
        digitalWrite(IN3, HIGH);
        digitalWrite(IN4, LOW);
        break;
      case 3:
        digitalWrite(IN1, LOW); 
        digitalWrite(IN2, HIGH);
        digitalWrite(IN3, HIGH);
        digitalWrite(IN4, LOW);
        break;
      case 4:
        digitalWrite(IN1, LOW); 
        digitalWrite(IN2, HIGH);
        digitalWrite(IN3, LOW);
        digitalWrite(IN4, LOW);
        break;
      case 5:
        digitalWrite(IN1, HIGH); 
        digitalWrite(IN2, HIGH);
        digitalWrite(IN3, LOW);
        digitalWrite(IN4, LOW);
        break;
      case 6:
        digitalWrite(IN1, HIGH); 
        digitalWrite(IN2, LOW);
        digitalWrite(IN3, LOW);
        digitalWrite(IN4, LOW);
        break;
      case 7:
        digitalWrite(IN1, HIGH); 
        digitalWrite(IN2, LOW);
        digitalWrite(IN3, LOW);
        digitalWrite(IN4, HIGH);
        break;
      default:
        digitalWrite(IN1, LOW); 
        digitalWrite(IN2, LOW);
        digitalWrite(IN3, LOW);
        digitalWrite(IN4, LOW);
        break;
    }
    SetDirection();
  }
}

void SetDirection() {
  if (Direction == 1) {
    Steps++;
  }
  if (Direction == 0) {
    Steps--;
  }
  if (Steps > 7) {
    Steps = 0;
  }
  if (Steps < 0) {
    Steps = 7;
  }
}
